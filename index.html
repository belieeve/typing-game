<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タイピング トレーナー</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow: hidden;
        }

        .game-container {
            background: white;
            border-radius: 15px;
            padding: 10px 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1200px;
            width: 100%;
            max-height: 98vh;
            overflow-y: auto;
        }

        .header {
            text-align: center;
            margin-bottom: 5px;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 3px;
        }

        .level-info {
            display: flex;
            justify-content: space-around;
            margin-bottom: 5px;
            font-size: 16px;
            font-weight: bold;
        }

        .level-badge {
            background: linear-gradient(135deg, #FF6B6B, #FFE66D);
            color: white;
            padding: 5px 15px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
        }

        .score-badge {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: white;
            padding: 5px 15px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(78,205,196,0.4);
        }

        .game-screen {
            text-align: center;
            margin: 5px 0;
        }

        .start-screen {
            display: block;
        }

        .play-screen {
            display: none;
        }

        .start-button {
            font-size: 24px;
            padding: 12px 35px;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(255,107,107,0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(255,107,107,0.6);
        }

        .start-button:active {
            transform: translateY(-1px);
        }

        .question-area {
            margin: 5px 0;
            padding: 10px;
            background: linear-gradient(135deg, #FFF9C4, #FFEB3B);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .question-hiragana {
            font-size: 56px;
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .question-romaji {
            font-size: 24px;
            color: #666;
            font-family: monospace;
            letter-spacing: 2px;
        }

        .input-display {
            font-size: 32px;
            color: #4ECDC4;
            font-family: monospace;
            letter-spacing: 4px;
            margin: 5px 0;
            min-height: 40px;
        }

        .keyboard {
            display: grid;
            gap: 2px;
            margin: 5px auto;
            max-width: 600px;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 2px;
        }

        .key {
            background: #f0f0f0;
            border: 2px solid #ccc;
            border-radius: 4px;
            padding: 6px;
            min-width: 35px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            transition: all 0.2s;
        }

        .key.highlight {
            background: linear-gradient(135deg, #FF6B6B, #FFE66D);
            border-color: #FF6B6B;
            color: white;
            transform: scale(1.2);
            box-shadow: 0 0 30px rgba(255,107,107,0.8);
            animation: pulse 0.6s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1.2); }
            50% { transform: scale(1.3); }
        }

        .key.space {
            min-width: 300px;
        }

        .progress-bar {
            width: 100%;
            height: 15px;
            background: #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            margin: 5px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ECDC4, #44A08D);
            transition: width 0.3s;
            border-radius: 8px;
        }

        .romaji-guide {
            margin-top: 5px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 8px;
            max-height: 100px;
            overflow-y: auto;
        }

        .romaji-guide h3 {
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
        }

        .guide-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 4px;
        }

        .guide-item {
            padding: 4px;
            background: white;
            border-radius: 4px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .guide-hiragana {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .guide-romaji {
            font-size: 11px;
            color: #666;
            font-family: monospace;
        }

        .feedback {
            font-size: 22px;
            font-weight: bold;
            margin: 5px 0;
            min-height: 28px;
        }

        .feedback.correct {
            color: #4ECDC4;
            animation: bounce 0.5s;
        }

        .feedback.wrong {
            color: #FF6B6B;
            animation: shake 0.5s;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0) scale(1); }
            25% { transform: translateY(-15px) scale(1.1); }
            50% { transform: translateY(-20px) scale(1.15); }
            75% { transform: translateY(-10px) scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .question-area {
            transition: background 0.5s ease;
        }

        .level-up {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
            text-align: center;
        }

        .level-up.show {
            display: block;
            animation: zoomIn 0.5s, celebrate 0.5s ease-in-out 0.2s;
        }

        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes celebrate {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(-5deg); }
            75% { transform: translate(-50%, -50%) rotate(5deg); }
        }

        .level-up h2 {
            font-size: 48px;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        .level-up button {
            font-size: 24px;
            padding: 15px 40px;
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
            transition: transform 0.2s;
        }

        .level-up button:hover {
            transform: scale(1.05);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
        }

        .overlay.show {
            display: block;
        }

        .home-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 6px 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            display: none;
        }

        .home-button:hover {
            transform: translateY(-2px);
        }

        .home-button.show {
            display: block;
        }

        .stats-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .star-counter {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.4);
        }

        .monster-area {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.5);
            border-radius: 15px;
            margin: 8px 0;
            display: none;
        }

        .monster-display {
            font-size: 64px;
            margin: 10px 0;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .monster-name {
            font-size: 14px;
            font-weight: bold;
            color: #666;
        }

        .monster-stage {
            font-size: 12px;
            color: #999;
        }

        .badges-container {
            margin-top: 8px;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 10px;
            text-align: center;
        }

        .badges-title {
            font-size: 12px;
            font-weight: bold;
            color: #666;
            margin-bottom: 5px;
        }

        .badges-grid {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .badge-item {
            font-size: 24px;
            opacity: 0.3;
            filter: grayscale(100%);
            transition: all 0.3s;
        }

        .badge-item.unlocked {
            opacity: 1;
            filter: grayscale(0%);
            animation: badgePop 0.5s;
        }

        @keyframes badgePop {
            0% { transform: scale(0); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .monster-evolution {
            animation: evolve 1s;
        }

        @keyframes evolve {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.2) rotate(10deg); }
            50% { transform: scale(0.8) rotate(-10deg); }
            75% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .calendar-button {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #FF6B6B, #FFE66D);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 6px 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }

        .calendar-button:hover {
            transform: translateY(-2px);
        }

        .calendar-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: none;
            z-index: 1001;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .calendar-modal.show {
            display: block;
            animation: zoomIn 0.3s;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav-button {
            background: #4ECDC4;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 5px 15px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }

        .calendar-nav-button:hover {
            background: #44A08D;
        }

        .streak-info {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 15px;
            color: white;
        }

        .streak-number {
            font-size: 36px;
            font-weight: bold;
            margin: 5px 0;
        }

        .streak-label {
            font-size: 14px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            color: #666;
            font-size: 12px;
            padding: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: #f0f0f0;
            font-size: 14px;
            position: relative;
            transition: transform 0.2s;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
        }

        .calendar-day.played {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: white;
            font-weight: bold;
        }

        .calendar-day.played::after {
            content: '⭐';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 18px;
        }

        .close-calendar {
            background: #FF6B6B;
            color: white;
            border: none;
            border-radius: 15px;
            padding: 10px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
        }

        .close-calendar:hover {
            background: #FF5252;
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
        }

        .stat-box {
            text-align: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 10px;
            flex: 1;
            margin: 0 5px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4ECDC4;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="game-container" style="position: relative;">
        <button class="home-button" id="homeButton" onclick="goHome()">🏠 トップへ</button>
        <button class="calendar-button" onclick="openCalendar()">📅 カレンダー</button>
        <div class="header">
            <div class="title">⚡ タイピング トレーナー ⚡</div>
        </div>

        <div class="stats-container">
            <div class="level-badge">レベル <span id="level">1</span></div>
            <div class="star-counter">⭐ <span id="totalStars">0</span></div>
            <div class="score-badge">スコア <span id="score">0/3</span></div>
        </div>

        <div class="monster-area" id="monsterArea">
            <div class="monster-display" id="monsterDisplay">🥚</div>
            <div class="monster-name" id="monsterName">たまご</div>
            <div class="monster-stage" id="monsterStage"></div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>

        <div class="game-screen">
            <div class="start-screen" id="startScreen">
                <p style="font-size: 18px; margin-bottom: 8px;">きみは タイピング トレーナー だ！</p>
                <p style="font-size: 14px; margin-bottom: 12px; color: #666;">もじを うって レベルアップ しよう！</p>
                <button class="start-button" onclick="startGame()">スタート！</button>
            </div>

            <div class="play-screen" id="playScreen">
                <div class="question-area" id="questionArea">
                    <div class="question-hiragana" id="questionHiragana">あ</div>
                    <div class="question-romaji" id="questionRomaji">a</div>
                </div>

                <div class="input-display" id="inputDisplay"></div>
                <div class="feedback" id="feedback"></div>

                <div class="keyboard" id="keyboard"></div>
            </div>
        </div>

        <div class="badges-container">
            <div class="badges-title">🏆 バッジコレクション</div>
            <div class="badges-grid" id="badgesGrid"></div>
        </div>

        <div class="romaji-guide">
            <h3>📖 ローマじ ひょう</h3>
            <div class="guide-grid" id="guideGrid"></div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="level-up" id="levelUpScreen">
        <h2>🎉 レベルアップ！</h2>
        <p style="font-size: 28px; margin: 15px 0;">レベル <span id="newLevel"></span> になったよ！</p>
        <button onclick="continuePlaying()">つぎへ！</button>
    </div>

    <div class="calendar-modal" id="calendarModal">
        <div class="calendar-header">
            <div class="calendar-title" id="calendarMonthTitle">2025年1月</div>
            <div class="calendar-nav">
                <button class="calendar-nav-button" onclick="changeMonth(-1)">◀</button>
                <button class="calendar-nav-button" onclick="changeMonth(1)">▶</button>
            </div>
        </div>

        <div class="streak-info">
            <div class="streak-number" id="streakNumber">0</div>
            <div class="streak-label">🔥 れんぞく にっすう</div>
        </div>

        <div class="stats-row">
            <div class="stat-box">
                <div class="stat-number" id="monthDays">0</div>
                <div class="stat-label">こんげつ</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="totalDays">0</div>
                <div class="stat-label">ぜんぶ</div>
            </div>
        </div>

        <div class="calendar-grid" id="calendarGrid"></div>

        <button class="close-calendar" onclick="closeCalendar()">とじる</button>
    </div>

    <script>
        // ゲームデータ
        const levels = [
            { level: 1, chars: ['あ', 'い', 'う', 'え', 'お'], questionsToPass: 3, hintRate: 1.0, theme: '#FFF9C4', monster: { egg: '🥚', baby: '🐣', adult: '🐥' }, name: 'ひよこ' },
            { level: 2, chars: ['あ', 'い', 'う', 'え', 'お', 'か', 'き', 'く', 'け', 'こ'], questionsToPass: 3, hintRate: 1.0, theme: '#FFF9C4', monster: { egg: '🥚', baby: '🐣', adult: '🐥' }, name: 'ひよこ' },
            { level: 3, chars: ['か', 'き', 'く', 'け', 'こ', 'さ', 'し', 'す', 'せ', 'そ'], questionsToPass: 5, hintRate: 1.0, theme: '#E1F5DD', monster: { egg: '🥚', baby: '🐣', adult: '🐤' }, name: 'にわとり' },
            { level: 4, chars: ['さ', 'し', 'す', 'せ', 'そ', 'た', 'ち', 'つ', 'て', 'と'], questionsToPass: 5, hintRate: 0.5, theme: '#E1F5DD', monster: { egg: '🥚', baby: '🐉', adult: '🐲' }, name: 'ドラゴン' },
            { level: 5, chars: ['た', 'ち', 'つ', 'て', 'と', 'な', 'に', 'ぬ', 'ね', 'の'], questionsToPass: 5, hintRate: 0.5, theme: '#D4E9FF', monster: { egg: '🥚', baby: '🐉', adult: '🐲' }, name: 'ドラゴン' },
            { level: 6, chars: ['な', 'に', 'ぬ', 'ね', 'の', 'は', 'ひ', 'ふ', 'へ', 'ほ'], questionsToPass: 5, hintRate: 0.5, theme: '#D4E9FF', monster: { egg: '🥚', baby: '🐉', adult: '🐲' }, name: 'ドラゴン' },
            { level: 7, chars: ['は', 'ひ', 'ふ', 'へ', 'ほ', 'ま', 'み', 'む', 'め', 'も'], questionsToPass: 7, hintRate: 0.33, theme: '#FFE8F0', monster: { egg: '🥚', baby: '🦄', adult: '✨' }, name: 'ユニコーン' },
            { level: 8, chars: ['ま', 'み', 'む', 'め', 'も', 'や', 'ゆ', 'よ', 'ら', 'り'], questionsToPass: 7, hintRate: 0.33, theme: '#FFE8F0', monster: { egg: '🥚', baby: '🦄', adult: '✨' }, name: 'ユニコーン' },
            { level: 9, chars: ['や', 'ゆ', 'よ', 'ら', 'り', 'る', 'れ', 'ろ', 'わ', 'を'], questionsToPass: 7, hintRate: 0.33, theme: '#FFF0E1', monster: { egg: '🥚', baby: '🦄', adult: '🦋' }, name: 'ちょうちょ' },
            { level: 10, chars: ['ら', 'り', 'る', 'れ', 'ろ', 'わ', 'を', 'ん'], questionsToPass: 7, hintRate: 0, theme: '#FFF0E1', monster: { egg: '🥚', baby: '👾', adult: '🤖' }, name: 'ロボット' },
            { level: 11, chars: ['が', 'ぎ', 'ぐ', 'げ', 'ご', 'ざ', 'じ', 'ず', 'ぜ', 'ぞ'], questionsToPass: 7, hintRate: 0, theme: '#E8E1FF', monster: { egg: '🥚', baby: '👾', adult: '🤖' }, name: 'ロボット' },
            { level: 12, chars: ['だ', 'ぢ', 'づ', 'で', 'ど', 'ば', 'び', 'ぶ', 'べ', 'ぼ'], questionsToPass: 7, hintRate: 0, theme: '#E8E1FF', monster: { egg: '🥚', baby: '👾', adult: '🤖' }, name: 'ロボット' },
            { level: 13, chars: ['ぱ', 'ぴ', 'ぷ', 'ぺ', 'ぽ'], questionsToPass: 5, hintRate: 0, theme: '#FFE1F0', monster: { egg: '🥚', baby: '⚡', adult: '🌟' }, name: 'スター' },
            { level: 14, chars: ['きゃ', 'きゅ', 'きょ', 'しゃ', 'しゅ', 'しょ', 'ちゃ', 'ちゅ', 'ちょ'], questionsToPass: 7, hintRate: 0, theme: '#FFE1F0', monster: { egg: '🥚', baby: '⚡', adult: '🌟' }, name: 'スター' },
            { level: 15, chars: ['ねこ', 'いぬ', 'うま', 'とり', 'さかな', 'はな', 'そら', 'かわ'], questionsToPass: 8, hintRate: 0, theme: '#FFD4E8', monster: { egg: '🥚', baby: '⚡', adult: '🌠' }, name: 'マスター' }
        ];

        // バッジデータ
        const badges = [
            { id: 'first', name: 'はじめの いっぽ', icon: '👣', condition: 'totalCorrect', value: 1 },
            { id: 'beginner', name: 'がんばりや', icon: '💪', condition: 'totalCorrect', value: 10 },
            { id: 'intermediate', name: 'すごいぞ！', icon: '🎖️', condition: 'totalCorrect', value: 50 },
            { id: 'level5', name: 'レベル5 たっせい', icon: '🏅', condition: 'maxLevel', value: 5 },
            { id: 'level10', name: 'レベル10 たっせい', icon: '🏆', condition: 'maxLevel', value: 10 },
            { id: 'star50', name: 'スターコレクター', icon: '⭐', condition: 'totalStars', value: 50 },
            { id: 'star100', name: 'スターマスター', icon: '🌟', condition: 'totalStars', value: 100 },
            { id: 'master', name: 'タイピングマスター', icon: '👑', condition: 'maxLevel', value: 15 }
        ];

        const hiraganaToRomaji = {
            'あ': 'a', 'い': 'i', 'う': 'u', 'え': 'e', 'お': 'o',
            'か': 'ka', 'き': 'ki', 'く': 'ku', 'け': 'ke', 'こ': 'ko',
            'さ': 'sa', 'し': 'shi', 'す': 'su', 'せ': 'se', 'そ': 'so',
            'た': 'ta', 'ち': 'chi', 'つ': 'tsu', 'て': 'te', 'と': 'to',
            'な': 'na', 'に': 'ni', 'ぬ': 'nu', 'ね': 'ne', 'の': 'no',
            'は': 'ha', 'ひ': 'hi', 'ふ': 'fu', 'へ': 'he', 'ほ': 'ho',
            'ま': 'ma', 'み': 'mi', 'む': 'mu', 'め': 'me', 'も': 'mo',
            'や': 'ya', 'ゆ': 'yu', 'よ': 'yo',
            'ら': 'ra', 'り': 'ri', 'る': 'ru', 'れ': 're', 'ろ': 'ro',
            'わ': 'wa', 'を': 'wo', 'ん': 'n',
            'が': 'ga', 'ぎ': 'gi', 'ぐ': 'gu', 'げ': 'ge', 'ご': 'go',
            'ざ': 'za', 'じ': 'ji', 'ず': 'zu', 'ぜ': 'ze', 'ぞ': 'zo',
            'だ': 'da', 'ぢ': 'di', 'づ': 'du', 'で': 'de', 'ど': 'do',
            'ば': 'ba', 'び': 'bi', 'ぶ': 'bu', 'べ': 'be', 'ぼ': 'bo',
            'ぱ': 'pa', 'ぴ': 'pi', 'ぷ': 'pu', 'ぺ': 'pe', 'ぽ': 'po',
            'きゃ': 'kya', 'きゅ': 'kyu', 'きょ': 'kyo',
            'しゃ': 'sha', 'しゅ': 'shu', 'しょ': 'sho',
            'ちゃ': 'cha', 'ちゅ': 'chu', 'ちょ': 'cho',
            'にゃ': 'nya', 'にゅ': 'nyu', 'にょ': 'nyo',
            'ひゃ': 'hya', 'ひゅ': 'hyu', 'ひょ': 'hyo',
            'みゃ': 'mya', 'みゅ': 'myu', 'みょ': 'myo',
            'りゃ': 'rya', 'りゅ': 'ryu', 'りょ': 'ryo',
            'ぎゃ': 'gya', 'ぎゅ': 'gyu', 'ぎょ': 'gyo',
            'じゃ': 'ja', 'じゅ': 'ju', 'じょ': 'jo',
            'びゃ': 'bya', 'びゅ': 'byu', 'びょ': 'byo',
            'ぴゃ': 'pya', 'ぴゅ': 'pyu', 'ぴょ': 'pyo',
            'ねこ': 'neko', 'いぬ': 'inu', 'うま': 'uma', 'とり': 'tori',
            'さかな': 'sakana', 'はな': 'hana', 'そら': 'sora', 'かわ': 'kawa'
        };

        let currentLevel = 1;
        let currentScore = 0;
        let currentQuestion = '';
        let currentAnswer = '';
        let currentInput = '';
        let comboCount = 0;
        let shouldShowHint = true;
        let totalQuestionsInLevel = 0;

        // スター＆バッジデータ（localStorage保存）
        let gameData = {
            totalStars: 0,
            totalCorrect: 0,
            maxLevel: 1,
            unlockedBadges: [],
            playedDates: [] // ["2025-01-15", "2025-01-16", ...]
        };

        // カレンダー表示用
        let currentCalendarYear = new Date().getFullYear();
        let currentCalendarMonth = new Date().getMonth(); // 0-11

        // 正解メッセージのバリエーション
        const successMessages = [
            '⭐ せいかい！',
            '✨ すごい！',
            '🎉 やったね！',
            '👏 すばらしい！',
            '💫 かんぺき！',
            '🌟 さいこう！'
        ];

        const comboMessages = [
            '🔥 コンボ！',
            '⚡ れんぞく！',
            '💪 ちょうし いいね！',
            '🚀 すごいぞ！'
        ];

        // localStorageからデータ読み込み
        function loadGameData() {
            const saved = localStorage.getItem('typingGameData');
            if (saved) {
                gameData = JSON.parse(saved);
            }
        }

        // localStorageにデータ保存
        function saveGameData() {
            localStorage.setItem('typingGameData', JSON.stringify(gameData));
        }

        // バッジチェック
        function checkAndUnlockBadges() {
            badges.forEach(badge => {
                if (!gameData.unlockedBadges.includes(badge.id)) {
                    let unlock = false;
                    if (badge.condition === 'totalCorrect' && gameData.totalCorrect >= badge.value) {
                        unlock = true;
                    } else if (badge.condition === 'totalStars' && gameData.totalStars >= badge.value) {
                        unlock = true;
                    } else if (badge.condition === 'maxLevel' && gameData.maxLevel >= badge.value) {
                        unlock = true;
                    }

                    if (unlock) {
                        gameData.unlockedBadges.push(badge.id);
                        showBadgeUnlock(badge);
                        saveGameData();
                    }
                }
            });
        }

        // バッジ獲得演出
        function showBadgeUnlock(badge) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = `🎊 バッジゲット！ ${badge.icon} ${badge.name}`;
            feedback.className = 'feedback correct';
        }

        // バッジ表示更新
        function updateBadgesDisplay() {
            const badgesGrid = document.getElementById('badgesGrid');
            badgesGrid.innerHTML = '';

            badges.forEach(badge => {
                const badgeDiv = document.createElement('div');
                badgeDiv.className = 'badge-item';
                badgeDiv.textContent = badge.icon;
                badgeDiv.title = badge.name;

                if (gameData.unlockedBadges.includes(badge.id)) {
                    badgeDiv.classList.add('unlocked');
                }

                badgesGrid.appendChild(badgeDiv);
            });
        }

        // モンスター表示更新
        function updateMonsterDisplay() {
            const levelData = levels[currentLevel - 1];
            const monsterData = levelData.monster;
            const monsterDisplay = document.getElementById('monsterDisplay');
            const monsterName = document.getElementById('monsterName');
            const monsterStage = document.getElementById('monsterStage');

            let currentMonster = monsterData.egg;
            let stageName = 'たまご';

            const progress = currentScore / levelData.questionsToPass;

            if (progress >= 0.66) {
                currentMonster = monsterData.adult;
                stageName = levelData.name;
            } else if (progress >= 0.33) {
                currentMonster = monsterData.baby;
                stageName = 'せいちょうちゅう';
            }

            if (monsterDisplay.textContent !== currentMonster) {
                monsterDisplay.classList.add('monster-evolution');
                setTimeout(() => {
                    monsterDisplay.classList.remove('monster-evolution');
                }, 1000);
            }

            monsterDisplay.textContent = currentMonster;
            monsterName.textContent = stageName;
            monsterStage.textContent = `${currentScore} / ${levelData.questionsToPass}`;
        }

        // スター表示更新
        function updateStarsDisplay() {
            document.getElementById('totalStars').textContent = gameData.totalStars;
        }

        // 今日の日付を記録
        function recordTodayPlay() {
            const today = new Date();
            const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            if (!gameData.playedDates.includes(dateStr)) {
                gameData.playedDates.push(dateStr);
                saveGameData();
            }
        }

        // 連続プレイ日数を計算
        function calculateStreak() {
            if (gameData.playedDates.length === 0) return 0;

            const sortedDates = gameData.playedDates.sort().reverse();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let streak = 0;
            let checkDate = new Date(today);

            for (let i = 0; i < sortedDates.length; i++) {
                const playedDate = new Date(sortedDates[i]);
                playedDate.setHours(0, 0, 0, 0);

                const diffDays = Math.floor((checkDate - playedDate) / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else if (diffDays === 1) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }

            return streak;
        }

        // カレンダーを開く
        function openCalendar() {
            document.getElementById('calendarModal').classList.add('show');
            document.getElementById('overlay').classList.add('show');
            renderCalendar();
        }

        // カレンダーを閉じる
        function closeCalendar() {
            document.getElementById('calendarModal').classList.remove('show');
            document.getElementById('overlay').classList.remove('show');
        }

        // 月を変更
        function changeMonth(direction) {
            currentCalendarMonth += direction;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            } else if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            renderCalendar();
        }

        // カレンダーを描画
        function renderCalendar() {
            const year = currentCalendarYear;
            const month = currentCalendarMonth;

            // タイトル更新
            document.getElementById('calendarMonthTitle').textContent = `${year}年${month + 1}月`;

            // 統計情報更新
            const streak = calculateStreak();
            document.getElementById('streakNumber').textContent = streak;

            // 今月のプレイ日数
            const monthStart = `${year}-${String(month + 1).padStart(2, '0')}-01`;
            const monthEnd = `${year}-${String(month + 1).padStart(2, '0')}-31`;
            const monthDays = gameData.playedDates.filter(d => d >= monthStart && d <= monthEnd).length;
            document.getElementById('monthDays').textContent = monthDays;

            // 総プレイ日数
            document.getElementById('totalDays').textContent = gameData.playedDates.length;

            // カレンダーグリッド描画
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // 曜日ヘッダー
            const dayHeaders = ['日', '月', '火', '水', '木', '金', '土'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            // 月の最初の日と最後の日
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            // 前月の日数を埋める
            const firstDayOfWeek = firstDay.getDay();
            for (let i = 0; i < firstDayOfWeek; i++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day other-month';
                grid.appendChild(dayCell);
            }

            // 今月の日付
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // 今日
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayCell.classList.add('today');
                }

                // プレイした日
                if (gameData.playedDates.includes(dateStr)) {
                    dayCell.classList.add('played');
                }

                grid.appendChild(dayCell);
            }
        }

        // オーバーレイクリックで閉じる
        document.getElementById('overlay').addEventListener('click', () => {
            if (document.getElementById('calendarModal').classList.contains('show')) {
                closeCalendar();
            }
        });

        // ページ読み込み時の初期化
        window.addEventListener('load', () => {
            loadGameData();
            updateStarsDisplay();
            updateBadgesDisplay();
            recordTodayPlay(); // 今日の日付を記録
        });

        function createKeyboard() {
            const keyboard = document.getElementById('keyboard');
            // 既存のキーボードをクリア
            keyboard.innerHTML = '';

            const layout = [
                ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'],
                ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'],
                ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l'],
                ['z', 'x', 'c', 'v', 'b', 'n', 'm']
            ];

            layout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'keyboard-row';
                row.forEach(key => {
                    const keyDiv = document.createElement('div');
                    keyDiv.className = 'key';
                    keyDiv.textContent = key.toUpperCase();
                    keyDiv.id = `key-${key}`;
                    rowDiv.appendChild(keyDiv);
                });
                keyboard.appendChild(rowDiv);
            });
        }

        function updateRomajiGuide() {
            const guideGrid = document.getElementById('guideGrid');
            guideGrid.innerHTML = '';

            const currentLevelData = levels[currentLevel - 1];
            currentLevelData.chars.forEach(char => {
                const romaji = hiraganaToRomaji[char];
                if (romaji) {
                    const item = document.createElement('div');
                    item.className = 'guide-item';
                    item.innerHTML = `
                        <div class="guide-hiragana">${char}</div>
                        <div class="guide-romaji">${romaji}</div>
                    `;
                    guideGrid.appendChild(item);
                }
            });
        }

        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('playScreen').style.display = 'block';
            document.getElementById('homeButton').classList.add('show');
            document.getElementById('monsterArea').style.display = 'block';
            createKeyboard();
            updateRomajiGuide();
            updateMonsterDisplay();
            nextQuestion();
        }

        function goHome() {
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('playScreen').style.display = 'none';
            document.getElementById('homeButton').classList.remove('show');
            document.getElementById('monsterArea').style.display = 'none';
            // ゲーム状態をリセット
            currentLevel = 1;
            currentScore = 0;
            comboCount = 0;
            totalQuestionsInLevel = 0;
            document.getElementById('level').textContent = currentLevel;
            const currentLevelData = levels[currentLevel - 1];
            document.getElementById('score').textContent = currentScore + '/' + currentLevelData.questionsToPass;
            document.getElementById('progress').style.width = '0%';
            updateMonsterDisplay();
        }

        function nextQuestion() {
            const levelData = levels[currentLevel - 1];
            const randomChar = levelData.chars[Math.floor(Math.random() * levelData.chars.length)];
            currentQuestion = randomChar;
            currentAnswer = hiraganaToRomaji[randomChar];
            currentInput = '';
            totalQuestionsInLevel++;

            // ヒント表示の判定
            const hintRate = levelData.hintRate;
            shouldShowHint = Math.random() < hintRate;

            // 問題エリアの背景色をレベルテーマに変更
            const questionArea = document.getElementById('questionArea');
            questionArea.style.background = `linear-gradient(135deg, ${levelData.theme}, #FFEB3B)`;

            document.getElementById('questionHiragana').textContent = currentQuestion;
            document.getElementById('questionRomaji').textContent = currentAnswer;
            document.getElementById('inputDisplay').textContent = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';

            highlightNextKey();
        }

        function highlightNextKey() {
            // すべてのキーのハイライトを解除
            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('highlight');
            });

            // ヒントを表示する場合のみハイライト
            if (shouldShowHint && currentInput.length < currentAnswer.length) {
                const nextChar = currentAnswer[currentInput.length].toLowerCase();
                const keyElement = document.getElementById(`key-${nextChar}`);
                if (keyElement) {
                    keyElement.classList.add('highlight');
                }
            }
        }

        document.addEventListener('keydown', (e) => {
            if (document.getElementById('playScreen').style.display === 'none') return;
            if (document.getElementById('levelUpScreen').classList.contains('show')) return;

            const key = e.key.toLowerCase();

            if (currentInput.length < currentAnswer.length) {
                const expectedChar = currentAnswer[currentInput.length].toLowerCase();

                if (key === expectedChar) {
                    currentInput += key;
                    document.getElementById('inputDisplay').textContent = currentInput;

                    if (currentInput === currentAnswer) {
                        // 正解！
                        comboCount++;
                        currentScore++;

                        // スター獲得
                        gameData.totalStars++;
                        gameData.totalCorrect++;
                        updateStarsDisplay();
                        saveGameData();

                        // バッジチェック
                        checkAndUnlockBadges();

                        // メッセージの選択
                        let message = successMessages[Math.floor(Math.random() * successMessages.length)];

                        // コンボメッセージの追加
                        if (comboCount >= 3) {
                            const comboMsg = comboMessages[Math.floor(Math.random() * comboMessages.length)];
                            message = message + ' ' + comboMsg + ' (x' + comboCount + ')';
                        }

                        document.getElementById('feedback').textContent = message + ' +⭐';
                        document.getElementById('feedback').className = 'feedback correct';
                        updateScore();
                        updateMonsterDisplay();

                        setTimeout(() => {
                            const currentLevelData = levels[currentLevel - 1];
                            if (currentScore >= currentLevelData.questionsToPass) {
                                levelUp();
                            } else {
                                nextQuestion();
                            }
                        }, 1000);
                    } else {
                        highlightNextKey();
                    }
                } else {
                    // 不正解
                    comboCount = 0; // コンボリセット
                    const hintText = shouldShowHint ? '' : expectedChar.toUpperCase() + ' を おして！';
                    document.getElementById('feedback').textContent = '❌ ちがうよ！ ' + hintText;
                    document.getElementById('feedback').className = 'feedback wrong';
                }
            }
        });

        function updateScore() {
            const currentLevelData = levels[currentLevel - 1];
            const maxScore = currentLevelData.questionsToPass;
            document.getElementById('score').textContent = currentScore + '/' + maxScore;
            const progress = (currentScore / maxScore) * 100;
            document.getElementById('progress').style.width = progress + '%';
        }

        function levelUp() {
            if (currentLevel < levels.length) {
                currentLevel++;
                currentScore = 0;
                comboCount = 0;
                totalQuestionsInLevel = 0;

                // 最大レベル更新
                if (currentLevel > gameData.maxLevel) {
                    gameData.maxLevel = currentLevel;
                    saveGameData();
                    checkAndUnlockBadges();
                }

                document.getElementById('level').textContent = currentLevel;
                document.getElementById('newLevel').textContent = currentLevel;
                document.getElementById('overlay').classList.add('show');
                document.getElementById('levelUpScreen').classList.add('show');
                updateRomajiGuide();
                updateMonsterDisplay();
            } else {
                // 全レベルクリア
                gameData.maxLevel = 15;
                saveGameData();
                checkAndUnlockBadges();
                alert('🎊 おめでとう！ ぜんぶ クリア したよ！ 🎊\nあなたは タイピング マスター だ！\n⭐ トータルスター: ' + gameData.totalStars);
                currentScore = 0;
            }
            updateScore();
            updateBadgesDisplay();
        }

        function continuePlaying() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('levelUpScreen').classList.remove('show');
            updateMonsterDisplay();
            nextQuestion();
        }
    </script>
</body>
</html>
